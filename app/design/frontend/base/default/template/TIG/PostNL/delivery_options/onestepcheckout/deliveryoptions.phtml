<?php
/**
 *                  ___________       __            __
 *                  \__    ___/____ _/  |_ _____   |  |
 *                    |    |  /  _ \\   __\\__  \  |  |
 *                    |    | |  |_| ||  |   / __ \_|  |__
 *                    |____|  \____/ |__|  (____  /|____/
 *                                              \/
 *          ___          __                                   __
 *         |   |  ____ _/  |_   ____ _______   ____    ____ _/  |_
 *         |   | /    \\   __\_/ __ \\_  __ \ /    \ _/ __ \\   __\
 *         |   ||   |  \|  |  \  ___/ |  | \/|   |  \\  ___/ |  |
 *         |___||___|  /|__|   \_____>|__|   |___|  / \_____>|__|
 *                  \/                           \/
 *                  ________
 *                 /  _____/_______   ____   __ __ ______
 *                /   \  ___\_  __ \ /  _ \ |  |  \\____ \
 *                \    \_\  \|  | \/|  |_| ||  |  /|  |_| |
 *                 \______  /|__|    \____/ |____/ |   __/
 *                        \/                       |__|
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Creative Commons License.
 * It is available through the world-wide-web at this URL:
 * http://creativecommons.org/licenses/by-nc-nd/3.0/nl/deed.en_US
 * If you are unable to obtain it through the world-wide-web, please send an email
 * to servicedesk@totalinternetgroup.nl so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade this module to newer
 * versions in the future. If you wish to customize this module for your
 * needs please contact servicedesk@totalinternetgroup.nl for more information.
 *
 * @copyright   Copyright (c) 2014 Total Internet Group B.V. (http://www.totalinternetgroup.nl)
 * @license     http://creativecommons.org/licenses/by-nc-nd/3.0/nl/deed.en_US
 */
?>
<?php
/**
 * @var TIG_PostNL_Block_DeliveryOptions_Checkout_Onepage_DeliveryOptions $this
 * @var Mage_Sales_Model_Quote_Address $_address
 */
?>
<?php $_address       = $this->getShippingAddress(); ?>
<?php $_postcode      = $this->getPostcode(); ?>
<?php $_deliveryDate  = $this->getDeliveryDate(); ?>
<?php $_streetData    = $this->getStreetData(); ?>
<?php $_housenumber   = $_streetData['housenumber']; ?>

<?php $_hidden = false; ?>

<?php if (!$_postcode || !$_postcode == '-' || !$_housenumber): ?>
    <?php $_hidden = true; ?>
<?php endif; ?>

<div id="postnl_add_moment" <?php if ($_hidden): ?>style="display: none;"<?php endif; ?>>
    <ul class="option-list">
        <li class="location">
            <div class="bkg">
                <div class="bkg">
                    <div class="content">
                        <strong class="location-name overflow-protect"><?php echo $_address->getStreetFull(); ?></strong>
                    </div>
                </div>
            </div>
        </li>
    </ul>
    <ul class="option-list">
        <li class="add-moment">
            <a id="add_moment_link" class="button action" ><span><span><?php echo $this->__('Or pick your own delivery moment'); ?></span></span></a>
        </li>
    </ul>
</div>
<div id="postnl_delivery_options" style="display:none;">
    <div class="popup-overlay">
        <div class="popup-window">
            <div class="popup-header title">
                <h2><?php echo $this->__('Delivery Options'); ?></h2>
                <a title="<?php echo $this->__('Close'); ?>" id="close_options_popup" class="btn-close"><?php echo $this->__('Close'); ?></a>
            </div>
            <div id="initial_loader"><?php echo $this->__('Loading...'); ?></div>
            <div id="osc_scrollbar_container" style="display:none;">
                <div id="osc_scrollbar_track">
                    <div id="osc_scrollbar_handle"></div>
                </div>
                <div id="osc_scrollbar_content" class="popup-content col2-set">
                    <div id="postnl_delivery" class="col-1">
                        <h3 class="sub-title"><?php echo $this->__('Delivery'); ?></h3>
                        <ul class="option-list" id="timeframes">
                            <li class="location">
                                <div class="bkg">
                                    <div class="bkg">
                                        <div class="content">
                                            <strong class="location-name"><?php echo $_address->getStreetFull(); ?></strong>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div id="postnl_pickup" class="col-2">
                        <h3 class="sub-title"><?php echo $this->__('or Pickup'); ?></h3>
                        <ul class="option-list" id="pgelocation"></ul>
                        <ul class="option-list" id="pglocation"></ul>
                        <ul class="option-list" id="palocation"></ul>
                        <ul class="option-list" id="customlocation"></ul>
                        <ul class="option-list" id="add_location">
                            <li class="add-location">
                                <a id="add_location_link" href="#" ><?php echo $this->__('choose a different pickup location'); ?></a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="button-set">
                <button type="button" class="button btn-save next" id="close_options_popup_btn">
                    <span>
                        <span><?php echo $this->__('Save'); ?></span>
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>
<?php echo $this->getChildHtml('postnl.osc.add.location') ?>
<?php echo $this->getChildHtml('postnl.add.phonenumber') ?>
<script type="text/javascript">
//<![CDATA[
    /**
     * Preload an array of images.
     */
    var baseUrl = '<?php echo $this->getSkinUrl('images/TIG/PostNL/deliveryoptions/locations'); ?>';
    var images = [
        'albertheijn', 'bruna', 'c1000', 'coop', 'default', 'emte', 'jumbo', 'plus', 'primera', 'readshop', 'spar',
        'staples', 'gamma', 'karwei'
    ];
    preloadImages(images);

    /**
     * Register OSC specific observers.
     */
    registerOscObservers();

    /**
     * Get some required variables and start the delivery options script.
     */
    var postcode = '<?php echo $_postcode; ?>';
    var housenumber = <?php echo $_housenumber; ?>;
    var fullAddress = "<?php echo implode(' ', $_address->getStreet()) . ', ' . $_address->getCity() . ', ' . $_address->getPostcode() . ', ' . $_address->getCountry(); ?>";

    <?php if (!$_hidden): ?>
        startDeliveryOptions(postcode, housenumber, fullAddress);
    <?php endif; ?>

    /**
     * Hack to prevent OSC from spamming a set_methods_seperate AJAX call every time the address search field is
     * clicked.
     */
    var searchField = $('search_field');
    searchField.stopObserving('click');
    searchField.observe('click', function() {
        searchField.stopObserving('click');
    });

    /**
     * Start the elivery options script.
     *
     * @param {string} postcode
     * @param {int}    housenumber
     * @param {string} fullAddress
     */
    function startDeliveryOptions(postcode, housenumber, fullAddress) {
        var options;
        var params;
        var deliveryOptions;

        params = {
            saveUrl            : '<?php echo $this->getUrl('postnl/deliveryOptions/saveSelectedOption', array('_secure' => true)) ?>',
            timeframesUrl      : '<?php echo $this->getUrl('postnl/deliveryOptions/getDeliveryTimeframes', array('_secure' => true)) ?>',
            locationsUrl       : '<?php echo $this->getUrl('postnl/deliveryOptions/getNearestLocations', array('_secure' => true)) ?>',
            locationsInAreaUrl : '<?php echo $this->getUrl('postnl/deliveryOptions/getLocationsInArea', array('_secure' => true)) ?>',
            postcode           : postcode,
            housenumber        : housenumber,
            deliveryDate       : '<?php echo $_deliveryDate; ?>',
            imageBaseUrl       : baseUrl,
            fullAddress        : fullAddress
        };

        options = {
            isOsc                  : true,
            eveningFee             : <?php echo $this->getFee('evening'); ?>,
            expressFee             : <?php echo $this->getFee('express'); ?>,
            eveningFeeText         : '<?php echo $this->getFeeText('evening'); ?>',
            expressFeeText         : '<?php echo $this->getFeeText('express'); ?>',
            allowPg                : <?php echo $this->canUsePakjeGemak()        ? 'true' : 'false'; ?>,
            allowPge               : <?php echo $this->canUsePakjeGemakExpress() ? 'true' : 'false'; ?>,
            allowPa                : <?php echo $this->canUsePakketAutomaat()    ? 'true' : 'false'; ?>,
            allowTimeframes        : <?php echo $this->canUseTimeframes()        ? 'true' : 'false'; ?>,
            allowEveningTimeframes : <?php echo $this->canUseEveningTimeframes() ? 'true' : 'false'; ?>,
            allowStreetview        : <?php echo $this->canUseStreetview() ? 'true' : 'false'; ?>,
            optionsContainer       : 'osc_scrollbar_container'
        };


        try {
            deliveryOptions = new PostnlDeliveryOptions(params, options);
        } catch(e) {
            console.log(e);
        }

        if (typeof deliveryOptions != 'undefined') {
            try {
                deliveryOptions.showOptions();
            } catch(e) {
                console.log(e);
                $('initial_loader').hide();
                $('osc_scrollbar_container').show();
                $('postnl_pickup').hide();
                $('add_moment_link').hide();
            }
        }

        if (typeof initCufon != 'undefined') {
            initCufon();
        }
    }

    /**
     * Preload images.
     *
     * @param {Array} images
     */
    function preloadImages(images) {
        var loadedImages = [];

        for (var i = 0, o = images.length; i < images.length; i++, o++) {
            loadedImages[i] = new Image();
            loadedImages[i].src = baseUrl + '/drp_' + images[i] + '.png';

            loadedImages[o] = new Image();
            loadedImages[o].src = baseUrl + '/crc_' + images[i] + '.png';
        }
    }

    /**
     * Register a bunch of OSC specific observers
     */
    function registerOscObservers() {
        $('add_moment_link').observe('click', function(event) {
            event.stop();

            $('postnl_delivery_options').show();
        });

        $('close_options_popup').observe('click', function(event) {
            event.stop();

            $('postnl_delivery_options').hide();
        });

        $('close_options_popup_btn').observe('click', function(event) {
            event.stop();

            $('postnl_delivery_options').hide();
        });

        var url_save_billing = '<?php echo $this->getUrl('onestepcheckout/ajax/save_billing', array('_secure'=>true)); ?>';
        var url_set_methods = '<?php echo $this->getUrl('onestepcheckout/ajax/set_methods_separate', array('_secure'=>true)); ?>';

        var fieldsToObserve = [
            'virtual:billing:street1',
            'billing:street1',
            'virtual:shipping:street1',
            'shipping:street1'
        ];

        fieldsToObserve.each(function(field) {
            $(field).observe('change', function() {
                get_save_billing_function(url_save_billing, url_set_methods, false)();
            });
        });

        $$('body')[0].stopObserving('postcodecheck:update_success');
        $$('body')[0].observe('postcodecheck:update_success', function() {
            get_save_billing_function(url_save_billing, url_set_methods, false)();
        });
    }

//]]>
</script>
